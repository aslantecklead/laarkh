# Обновления приложения (Client Update Notices)

Документ описывает, как работать с объявлениями об обновлениях для мобильного клиента.

## Коллекции

### `app_updates`
- `version` — версия релиза (например `0.3`, `1.2`)
- `min_app_version` — минимально допустимая версия клиента (если ниже — показываем)
- `max_app_version` — опционально, верхняя граница версий, которым показывать
- `message` — текст объявления
- `severity` — `info` или `critical`
- `telegram_url` — ссылка на пост/анонс
- `is_active` — флаг активности
- `force` — если `true`, нельзя закрыть и нужно обновить приложение
- `starts_at`, `ends_at`, `created_at` — временные поля

### `update_ack`
Фиксирует, что `info`-объявление показано и закрыто:
- `update_id` — ссылка на `app_updates._id`
- `device_id` — идентификатор устройства
- `user_id` — опционально
- `acked_at`

## Ручки

### `GET /api/updates/latest`
Возвращает активное объявление (или `null`). Важные правила:
- `critical` (или `force=true`) возвращается всегда, если версия клиента ниже `min_app_version`.
- `info` возвращается только если еще не было `ack`.

Параметры:
- `app_version` — версия клиента
- `device_id` — идентификатор устройства
- `user_id` — опционально

### `POST /api/updates/ack`
Отмечает `info`-объявление как прочитанное:
```json
{
  "update_id": "app_update_id",
  "device_id": "device-123",
  "user_id": "optional"
}
```

## Клиентская логика (коротко)

### Когда проверять
- При возврате приложения из фона в активное состояние (`AppState: active`).
- Всегда делать новый запрос к API, без ограничения по времени и без клиентского кэша.

### Как показывать
- `critical` или `force=true`: блокирующий экран без возможности закрыть.
- `info`: плашка/модалка, которую можно закрыть (с `ack`).

### Версии
Сравнивать версии по числам, разделённым точкой:
```
0.3 < 0.10 < 1.2
```

Псевдокод:
```
compare(a, b):
  A = a.split(".").map(int)
  B = b.split(".").map(int)
  for i in 0..max(len(A),len(B))-1:
    ai = A[i] ?? 0
    bi = B[i] ?? 0
    if ai < bi return -1
    if ai > bi return 1
  return 0
```
